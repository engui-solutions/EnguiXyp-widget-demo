var tokenTypes=[{name:"",title:"Токены төрөл"},{name:"online",title:"Онлайн"},{name:"offline",title:"Оффлайн"}],token="",timestamp="",message="";const getDevices=async()=>{sL();let e=new WebSocket("ws://localhost:56825/ws");e.onopen=async t=>{e.send(JSON.stringify({app:"THIRD_WIDGET",token:token,type:289,step:0}))},e.onerror=e=>{enguiXyp.hR({status:"error",message:"cannot connect ES application"}),eL()},e.onmessage=async e=>{let t=JSON.parse(e.data);var n=t.result;if(200==t.code){var a=document.createElement("select");a.id="deviceE",a.name="deviceE";var s=document.createElement("option");s.value="",s.text="Төхөөрөмж сонгох",a.appendChild(s),n.forEach((e=>{var t=document.createElement("option");t.value=e.name,t.text=e.name,a.appendChild(t)}));var i=document.getElementById("tokenListE");i.appendChild(a);var r=document.createElement("input");r.id="pinInput",r.type="password",r.autocomplete="new-password",r.placeholder="Пин код",i.appendChild(r)}else enguiXyp.hR({status:"error",message:t.message});eL()}},sL=()=>{document.getElementById("loaderE").style.display="flex"},eL=()=>{document.getElementById("loaderE").style.display="none"},sC=e=>{let t=setInterval((()=>{e--;var n=document.getElementById("countE");n.textContent=`${parseInt(e/60)>9?"":"0"}${parseInt(e/60)}:${e%60>9?"":"0"}${e%60}`,0==e&&(clearInterval(t),n.textContent="")}),1e3)},gJ=async e=>{try{const t=await fetch(e);return await t.json()}catch(e){return enguiXyp.hR({status:"error",message:e}),null}};var enguiXyp={total:0,groups:[],init:async function(e){token=e.token,timestamp=e.timestamp,message=e.message,this.groups=await gJ(e.serviceJson);var t=document.getElementById("EnguiXyp");if(t){t.classList.add("enguiXyp");var n=document.createElement("div");n.id="loaderE",n.classList.add("loaderE");var a=document.createElement("div");a.id="loaderIconE",a.classList.add("loaderIconE"),n.appendChild(a),t.appendChild(n);var s=document.createElement("form");s.id="formE";var i=document.createElement("div");i.id="countE",s.appendChild(i),sC(e.expire_time);var r=document.createElement("div");r.id="fillE";var d=document.createElement("input");d.id="regnumE",d.type="text",d.placeholder="Регистр",d.value=e.params.regnum?e.params.regnum:"",r.appendChild(d);var o=document.createElement("input");o.id="phoneE",o.type="text",o.placeholder="Утас",o.value=e.params.phone?e.params.phone:"",r.appendChild(o),s.appendChild(r);var l=document.createElement("div");l.id="tokenListE",s.appendChild(l);var c=document.createElement("div");c.id="groupContainerE",s.appendChild(c),this.groups.forEach((t=>{var n=document.createElement("div");n.id="group_"+t.alias,n.textContent=t.name,n.classList.add("groupE"),c.appendChild(n);var a=document.createElement("div");a.id="services_"+t.alias,a.classList.add("servicesE"),c.appendChild(a),n.addEventListener("click",(()=>{var e=document.getElementById("group_"+t.alias);e.classList.toggle("active");var n=document.getElementById("services_"+t.alias);e.classList.contains("active")?n.style.display="block":n.style.display="none"})),t.services.forEach((t=>{var n=document.createElement("div"),s=document.createElement("input"),i=document.createElement("label"),r=document.createElement("div");n.id="ser_"+t.service,r.id="serp_"+t.service,r.classList.add("serParams"),s.id=t.service,s.type="checkbox",s.name=t.service,s.addEventListener("change",(e=>{e.target.checked?(this.total+=150,r.style.display="block"):(this.total-=150,r.style.display="none"),0==this.total?u.textContent="":u.textContent=`${this.total/150} x 150 + 100 = ${this.total+100}`})),i.htmlFor=t.service,i.textContent=t.name,n.appendChild(s),n.appendChild(i),n.appendChild(r),t.params&&t.params.forEach((n=>{var a=document.createElement("input");a.id=t.service+"_"+n.name,a.type="text",a.placeholder=n.label,"regnum"===n.name&&a.classList.add("regnumE"),e.params[n.name]&&(a.value=e.params[n.name]),r.appendChild(a)})),a.appendChild(n)}))}));var p=document.createElement("div");p.id="submitE",s.appendChild(p);var m=document.createElement("button");m.id="submitButtonE",m.textContent="Батлах",m.type="submit",p.appendChild(m);var u=document.createElement("div");u.id="totalPeeE",u.classList.add("totalPeeE"),s.appendChild(u);var v=document.createElement("select");v.id="tokenE",v.name="tokenE",tokenTypes.forEach(((e,t)=>{var n=document.createElement("option");n.value=e.name,n.text=e.title,v.appendChild(n),0==t&&(n.disabled=!0)})),l.appendChild(v),d.addEventListener("change",(e=>{for(var t=document.getElementsByClassName("regnumE"),n=0;n<t.length;n++)t[n].value=e.target.value})),v.addEventListener("change",(e=>{if("offline"===e.target.value)getDevices();else if("online"===e.target.value){const e=document.getElementById("deviceE"),t=document.getElementById("pinInput");e&&e.remove(),t&&t.remove()}})),t.appendChild(s),s.addEventListener("submit",this.submit)}else enguiXyp.hR({status:"error",message:"container mainEngui is no defined"})},hR:e=>{console.log(e)},onresponse:e=>{enguiXyp.hR=e},submit:async e=>{e.preventDefault();var t=!1;let n={regnum:"",phone:"",type:"",message:message,services:[]};if(enguiXyp.groups.forEach((e=>{let a=[];e.services.forEach((n=>{if(document.getElementById(n.service).checked){var s={alias:e.alias,sub:e.sub,service:n.service,version:n.version,params:{}};n.params&&n.params.forEach((e=>{var a=document.getElementById(n.service+"_"+e.name).value;""!==a?s.params[e.name]=a:t=!0})),a.push(s)}})),a.length>0&&n.services.push(...a)})),t)enguiXyp.hR({status:"error",message:"required fields"});else{var a=document.getElementById("tokenE").value,s=document.getElementById("phoneE").value,i=document.getElementById("regnumE").value;if(""!==s&&""!==i)if(n.regnum=i,n.phone=s,n.services.length>0)if("online"==a){n.type="online",sL();const e=await fetch("https://thirdparty.engui.mn/third/widget/get/data",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${token}`},body:JSON.stringify(n)}),t=await e.json();enguiXyp.hR(t),eL()}else if("offline"==a){n.type="offline";var r=document.getElementById("deviceE").value,d=document.getElementById("pinInput").value;if(""!==d&&""!==r){sL();let e=new WebSocket("ws://localhost:56825/ws");e.onopen=async t=>{e.send(JSON.stringify({app:"THIRD_WIDGET",token:token,type:289,pin:d,withCert:!0,data:window.btoa(`${i}.${timestamp}`.replace(/[\u00A0-\u2666]/g,(function(e){return"&#"+e.charCodeAt(0)+";"}))),name:r,step:2}))},e.onerror=e=>{enguiXyp.hR({status:"error",message:"cannot connect ES application"}),eL()},e.onmessage=async e=>{let t=JSON.parse(e.data);if(200==t.code){n.signature=t.result.signature,n.cert=t.result.cert;const e=await fetch("https://thirdparty.engui.mn/third/widget/get/data",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${token}`},body:JSON.stringify(n)}),a=await e.json();enguiXyp.hR(a)}else enguiXyp.hR({status:"error",message:t.message});eL()}}else enguiXyp.hR({status:"error",message:"required fields"})}else enguiXyp.hR({status:"error",message:"token type not selected"});else enguiXyp.hR({status:"error",message:"no service selected"});else enguiXyp.hR({status:"error",message:"required fields"})}}};