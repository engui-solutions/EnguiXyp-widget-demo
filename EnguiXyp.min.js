var tokenTypes=[{name:"",title:"Токены төрөл"},{name:"online",title:"Онлайн"},{name:"offline",title:"Оффлайн"}],token="",timestamp="",message="";const getDevices=async()=>{sL();let e=new WebSocket("ws://localhost:56825/ws");e.onopen=async t=>{e.send(JSON.stringify({app:"THIRD_WIDGET",token:token,type:289,step:0}))},e.onerror=e=>{enguiXyp.hR({status:"error",message:"cannot connect ES application"}),eL()},e.onmessage=async e=>{let t=JSON.parse(e.data);var a=t.result;if(200==t.code){var n=document.createElement("select");n.id="deviceE",n.name="deviceE";var s=document.createElement("option");s.value="",s.text="Төхөөрөмж сонгох",n.appendChild(s),a.forEach((e=>{var t=document.createElement("option");t.value=e.name,t.text=e.name,n.appendChild(t)}));var i=document.getElementById("tokenListE");i.appendChild(n);var r=document.createElement("input");r.id="pinInput",r.type="password",r.autocomplete="new-password",r.placeholder="Пин код",i.appendChild(r)}else enguiXyp.hR({status:"error",message:t.message});eL()}},sL=()=>{document.getElementById("loaderE").style.display="flex"},eL=()=>{document.getElementById("loaderE").style.display="none"},sC=e=>{let t=setInterval((()=>{e--;var a=document.getElementById("countE");a.textContent=`${parseInt(e/60)>9?"":"0"}${parseInt(e/60)}:${e%60>9?"":"0"}${e%60}`,0==e&&(clearInterval(t),a.textContent="")}),1e3)},gJ=async e=>{try{const t=await fetch(e);return await t.json()}catch(e){return enguiXyp.hR({status:"error",message:e}),null}};var enguiXyp={total:0,groups:[],init:async function(e){token=e.token,timestamp=e.timestamp,message=e.message,this.groups=await gJ(e.serviceJson);var t=document.getElementById("EnguiXyp");if(t){t.classList.add("enguiXyp");var a=document.createElement("div");a.id="loaderE",a.classList.add("loaderE");var n=document.createElement("div");n.id="loaderIconE",n.classList.add("loaderIconE"),a.appendChild(n),t.appendChild(a);var s=document.createElement("form");s.id="formE";var i=document.createElement("div");i.id="countE",s.appendChild(i),sC(e.expire_time);var r=document.createElement("div");r.id="fillE";var d=document.createElement("input");d.id="regnumE",d.type="text",d.placeholder="Регистр",d.value=e.params.regnum?e.params.regnum:"",r.appendChild(d);var o=document.createElement("input");o.id="phoneE",o.type="text",o.placeholder="Утас",o.value=e.params.phone?e.params.phone:"",r.appendChild(o),s.appendChild(r);var l=document.createElement("div");l.id="tokenListE",s.appendChild(l);var c=document.createElement("div");c.id="groupContainerE",s.appendChild(c),this.groups.forEach((t=>{var a=document.createElement("div");a.id="group_"+t.alias,a.textContent=t.name,a.classList.add("groupE"),c.appendChild(a);var n=document.createElement("div");n.id="services_"+t.alias,n.classList.add("servicesE"),c.appendChild(n),a.addEventListener("click",(()=>{var e=document.getElementById("group_"+t.alias);e.classList.toggle("active");var a=document.getElementById("services_"+t.alias);e.classList.contains("active")?a.style.display="block":a.style.display="none"})),t.services.forEach((t=>{var a=document.createElement("div"),s=document.createElement("input"),i=document.createElement("label"),r=document.createElement("div");a.id="ser_"+t.service,r.id="serp_"+t.service,r.classList.add("serParams"),s.id=t.service,s.type="checkbox",s.name=t.service,s.addEventListener("change",(e=>{e.target.checked?(this.total+=150,r.style.display="block"):(this.total-=150,r.style.display="none"),0==this.total?u.textContent="":u.textContent=`${this.total/150} x 150 + 100 = ${this.total+100}`})),i.htmlFor=t.service,i.textContent=t.name,a.appendChild(s),a.appendChild(i),a.appendChild(r),t.params&&t.params.forEach((a=>{var n=document.createElement("input");n.id=t.service+"_"+a.name,n.type="text",n.placeholder=a.label,"regnum"===a.name&&n.classList.add("regnumE"),e.params[a.name]&&(n.value=e.params[a.name]),r.appendChild(n)})),n.appendChild(a)}))}));var p=document.createElement("div");p.id="submitE",s.appendChild(p);var m=document.createElement("button");m.id="submitButtonE",m.textContent="Батлах",m.type="submit",p.appendChild(m);var u=document.createElement("div");u.id="totalPeeE",u.classList.add("totalPeeE"),s.appendChild(u);var g=document.createElement("select");g.id="tokenE",g.name="tokenE",tokenTypes.forEach(((e,t)=>{var a=document.createElement("option");a.value=e.name,a.text=e.title,g.appendChild(a),0==t&&(a.disabled=!0)})),l.appendChild(g),d.addEventListener("change",(e=>{for(var t=document.getElementsByClassName("regnumE"),a=0;a<t.length;a++)t[a].value=e.target.value})),g.addEventListener("change",(e=>{if("offline"===e.target.value)getDevices();else if("online"===e.target.value){const e=document.getElementById("deviceE"),t=document.getElementById("pinInput");e&&e.remove(),t&&t.remove()}})),t.appendChild(s),s.addEventListener("submit",this.submit)}else enguiXyp.hR({status:"error",message:"container mainEngui is no defined"})},hR:e=>{console.log(e)},onresponse:e=>{enguiXyp.hR=e},submit:async e=>{e.preventDefault();var t=!1;let a={regnum:"",phone:"",type:"",message:message,services:[]};if(enguiXyp.groups.forEach((e=>{let n=[];e.services.forEach((a=>{if(document.getElementById(a.service).checked){var s={alias:e.alias,sub:e.sub,service:a.service,version:a.version,params:{}};a.params&&a.params.forEach((e=>{var n=document.getElementById(a.service+"_"+e.name).value;""!==n?s.params[e.name]=n:t=!0})),n.push(s)}})),n.length>0&&a.services.push(...n)})),t)enguiXyp.hR({status:"error",message:"required fields"});else{var n=document.getElementById("tokenE").value,s=document.getElementById("phoneE").value,i=document.getElementById("regnumE").value;if(""!==s&&""!==i)if(a.regnum=i,a.phone=s,a.services.length>0)if("online"==n){a.type="online",sL();const e=await fetch("https://thirdparty.engui.mn/third/widget/get/data",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${token}`},body:JSON.stringify(a)}),t=await e.json();enguiXyp.hR(t),eL()}else if("offline"==n){a.type="offline";var r=document.getElementById("deviceE").value,d=document.getElementById("pinInput").value;if(""!==d&&""!==r){sL();let e=new WebSocket("ws://localhost:56825/ws");e.onopen=async t=>{e.send(JSON.stringify({app:"THIRD_WIDGET",token:token,type:289,pin:d,withCert:!0,data:window.btoa(`${i}.${timestamp}`.replace(/[\u00A0-\u2666]/g,(function(e){return"&#"+e.charCodeAt(0)+";"}))),name:r,step:2}))},e.onerror=e=>{enguiXyp.hR({status:"error",message:"cannot connect ES application"}),eL()},e.onmessage=async e=>{let t=JSON.parse(e.data);if(200==t.code){a.signature=t.result.signature,a.cert=t.result.cert,a.message=window.btoa(`${i}.${timestamp}`.replace(/[\u00A0-\u2666]/g,(function(e){return"&#"+e.charCodeAt(0)+";"})));const e=await fetch("https://thirdparty.engui.mn/third/widget/get/data",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${token}`},body:JSON.stringify(a)}),n=await e.json();enguiXyp.hR(n)}else enguiXyp.hR({status:"error",message:t.message});eL()}}else enguiXyp.hR({status:"error",message:"required fields"})}else enguiXyp.hR({status:"error",message:"token type not selected"});else enguiXyp.hR({status:"error",message:"no service selected"});else enguiXyp.hR({status:"error",message:"required fields"})}}};